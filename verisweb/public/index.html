<!DOCTYPE html>
<html lang="en-US" translate="no">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Veris</title>
  <style>
    .styled-table {
      border-collapse: collapse;
      margin: 25px 0;
      font-size: 0.9em;
      font-family: sans-serif;
      min-width: 400px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }

    .styled-table thead tr {
      background-color: #009879;
      color: #ffffff;
      text-align: left;
    }

    .styled-table th,
    .styled-table td {
      padding: 12px 15px;
    }

    .styled-table tbody tr {
      border-bottom: 1px solid #dddddd;
    }

    .styled-table tbody tr:nth-of-type(even) {
      background-color: #f3f3f3;
    }

    .styled-table tbody tr:last-of-type {
      border-bottom: 2px solid #009879;
    }

    .styled-table tbody tr.active-row {
      font-weight: bold;
      color: #009879;
    }
  </style>


</head>

<body>

  <main>
    <table class="styled-table">
      <caption>Veris DataBase</caption>
      <thead>
        <tr>

          <th>Study ID</th>

          <th>Download</th>
        </tr>
      </thead>
      <tbody id="myTable">
      </tbody>
    </table>
  </main>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-app.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, doc, getDocs, query, collectionGroup, where, orderBy } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-firestore.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCf_0n4ehVdWJwQ4qPT4Abu-dzB_cFipCQ",
      authDomain: "patdeployments.firebaseapp.com",
      databaseURL: "https://patdeployments-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "patdeployments",
      storageBucket: "patdeployments.appspot.com",
      messagingSenderId: "347571404214",
      appId: "1:347571404214:web:b14c10f03f7e63accb1517",
      measurementId: "G-4C07Z35G64"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    const db = getFirestore(app);
    const modulesRef = await query(collectionGroup(db, "studies"));
    const docsModulesSnap = await getDocs(modulesRef);

    var studyIdArray = [];
    var table = document.getElementById('myTable');
    docsModulesSnap.forEach(doc => {

      var id = doc.data().studyId;
      // console.log(doc.data());
      if (!studyIdArray.includes(id)) {
        studyIdArray.push(id);
        let tr = document.createElement('tr');
        let td_id = document.createElement('td');
        let td_btn = document.createElement('td');
        let btn = document.createElement('button');
        td_id.textContent = id;
        td_btn.setAttribute('id', id);
        btn.textContent = "Download";
        td_btn.addEventListener("click", function () {
          return getStudies(id);
        });
        td_btn.appendChild(btn);
        tr.appendChild(td_id);
        tr.appendChild(td_btn);

        table.appendChild(tr);
      }
    });
    try {

    } catch (error) {
      console.log(error);
    }





    async function getStudies(idStudy) {

      try {
        // console.log(idStudy);
        const queryModules = await query(collectionGroup(db, "studies"), where("studyId", "==", idStudy));

        const moduleSnapshot = await getDocs(queryModules);
        let csvData = [];
        moduleSnapshot.forEach((study) => {
          // console.log(study.data().values);
          console.log(study.data());

          let sortArr = [];
          var unsort = study.data().values;
          unsort.forEach((unsortedObj) => {
            // var sortValue = Object.keys(unsort).sort(function (a, b) { return unsort[a] - unsort[b] });
            const ordered = Object.keys(unsortedObj).sort().reduce(
              (obj, key) => {
                obj[key] = unsortedObj[key];
                return obj;
              },
              {}
            );

            sortArr.push(ordered);


          });
          // console.log(sortArr);
          // var sortValue = Object.keys(unsort).sort(function(a,b){return unsort[a]-unsort[b]});

          var myJsonString = JSON.stringify(sortArr);

          let rowData = [];
          rowData.push(study.data().userId);
          rowData.push(study.data().studyId);
          rowData.push(study.data().moduleId);
          rowData.push(study.data().sectionId);
          rowData.push(study.data().datetime.seconds);
          rowData.push(myJsonString);
          csvData.push(rowData);
          // console.log("+++++++");
        }
        );

        downloadCsvFile(csvData);

      } catch (error) {
        console.log(error);
      }
    }


    function downloadCsvFile(csvData) {

      //define the heading for each row of the data  
      var csv = 'User ID;Study ID;Module ID;Section ID;Unix Date;Data\n';

      //merge the data with CSV  
      csvData.forEach(function (row) {
        csv += row.join(';');
        csv += "\n";
      });

      //display the created CSV data on the web browser   
      document.write(csv);

      var hiddenElement = document.createElement('a');
      hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
      hiddenElement.target = '_blank';

      //provide the name for the CSV file to be downloaded  
      hiddenElement.download = 'Veris Test Result.csv';
      hiddenElement.click();
    }

  </script>
</body>

</html>